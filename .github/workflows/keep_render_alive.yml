name: Keep Render Alive (Advanced)

on:
  schedule:
    # Pingar a cada 14 minutos (Render dorme apÃ³s 15 min de inatividade)
    - cron: '*/14 * * * *'
  workflow_dispatch:

jobs:
  ping-render:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“Œ Checkout
        uses: actions/checkout@v4

      - name: ğŸ”„ Ping Render API
        run: |
          RENDER_URL="https://atlas-backend-fn5s.onrender.com"
          API_URL="https://atlas-backend-fn5s.onrender.com/api/health"
          
          echo "â° Timestamp: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "ğŸ“ Pinging: $RENDER_URL"
          echo ""
          
          # Tentar 3 vezes se falhar
          for i in {1..3}; do
            echo "ğŸ”„ Tentativa $i..."
            
            # Pingar a pÃ¡gina principal
            if curl -I --max-time 10 --connect-timeout 5 "$RENDER_URL" 2>/dev/null | head -n 1; then
              echo "âœ… Frontend respondeu!"
              break
            fi
            
            if [ $i -lt 3 ]; then
              echo "â³ Aguardando 5 segundos antes de tentar novamente..."
              sleep 5
            fi
          done
          
          echo ""
          echo "ğŸ”„ Pinging API..."
          
          # Pingar a API
          for i in {1..3}; do
            echo "ğŸ”„ Tentativa $i (API)..."
            
            if curl -I --max-time 10 --connect-timeout 5 "$API_URL" 2>/dev/null | head -n 1; then
              echo "âœ… API respondeu!"
              break
            fi
            
            if [ $i -lt 3 ]; then
              sleep 5
            fi
          done
          
          echo ""
          echo "âœ… Keep-alive executado com sucesso!"

      - name: ğŸ“Š Status Check
        if: always()
        run: |
          echo "ğŸ“Š Job Status: ${{ job.status }}"
          echo "â±ï¸ PrÃ³xima execuÃ§Ã£o: em ~14 minutos"

  # Job adicional para verificar mÃºltiplas URLs
  multi-ping:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ”„ Ping Multiple Endpoints
        run: |
          # Array de URLs para pingar
          declare -a urls=(
            "https://atlas-backend-fn5s.onrender.com"
            "https://atlas-backend-fn5s.onrender.com/api/get-all-data"
          )
          
          echo "ğŸš€ Iniciando multi-ping em $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          
          for url in "${urls[@]}"; do
            echo "ğŸ“ Pinging: $url"
            
            response=$(curl -s -w "%{http_code}" --max-time 10 --connect-timeout 5 "$url" -o /dev/null)
            
            if [ "$response" == "200" ] || [ "$response" == "304" ]; then
              echo "âœ… Status: $response (OK)"
            else
              echo "âš ï¸ Status: $response (PossÃ­vel erro, mas continuando...)"
            fi
            
            echo ""
          done
          
          echo "âœ… Multi-ping concluÃ­do!"